<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />

    <title>Building Web-Based Audio Player for Obscure Audio Format</title>

    <meta
      name="description"
      content="This talk is about a journey of doing something that has never been done before. It involves project restarts, reverse engineering, and many eureka moments."
    />
    <meta name="author" content="Kenrick" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" href="css/reset.css" />
    <link rel="stylesheet" href="css/reveal.css" />
    <link rel="stylesheet" href="css/theme/white.css" id="theme" />

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="lib/css/monokai.css" />

    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement('link');
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match(/print-pdf/gi)
        ? 'css/print/pdf.css'
        : 'css/print/paper.css';
      document.getElementsByTagName('head')[0].appendChild(link);
    </script>

    <!--[if lt IE 9]>
      <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
  </head>

  <body>
    <div class="reveal">
      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">
        <section>
          <h2>Building Web-Based Audio Player for Obscure Audio Format</h2>
        </section>

        <section>
          <h2>Hi there!</h2>
          <h3>Kenrick</h3>
          <p>Software Engineer, Shopee</p>
        </section>

        <section>
          <h2>Outline</h2>
          <ul>
            <li>Definitions</li>
            <li>Stories</li>
            <li>Lessons</li>
          </ul>
        </section>

        <section>
          <section>
            <h2>BRSTM</h2>
          </section>
          <section>
            <h2>BRSTM</h2>
            <ul>
              <li>File format</li>
              <li>Audio data, with <b>loop point</b>!</li>
              <li>Used in Nintendo Wii</li>
              <li>Popular in Nintendo modding community</li>
            </ul>
          </section>
          <section>
            <h2>BRSTM</h2>
            <p>HTML's <code>&lt;audio /&gt;</code> cannot play it!</p>
          </section>
        </section>

        <section>
          <h2>So how?</h2>
        </section>

        <section>
          <section>
            <h2>Idea (1)</h2>
          </section>
          <section>
            <h2>ffmpeg</h2>
          </section>
          <section>
            <h2>Big idea</h2>

            <ol>
              <li class="fragment">ffmpeg converts BRSTM to MP3</li>
              <li class="fragment">
                Play using <code>&lt;audio src="music.mp3" /&gt;</code>
              </li>
            </ol>
          </section>

          <section>
            <h2>Solved?</h2>
            <p class="fragment">
              No, it's not able to loop
            </p>
          </section>
        </section>

        <section>
          <section>
            <h2>Idea (2)</h2>
          </section>
          <section>
            <h2>Live stream</h2>
          </section>
          <section>
            <h2>Big idea</h2>

            <ul>
              <li>
                Server serves the current audio chunk (to support loop) [explain
                more]
              </li>
              <li>
                Client listens like listening online radio
              </li>
            </ul>
          </section>

          <section>
            <h2>Live streaming protocols</h2>
            <ul>
              <li>
                HLS: HTTP Live Streaming (old Safari/Edge)
              </li>
              <li>
                DASH: Dynamic Adaptive Streaming over HTTP (all other browsers)
              </li>
            </ul>
          </section>
          <section>
            <h2>The idea</h2>
            <ul>
              <li>
                Server implements DASH protocol
              </li>
              <li>
                Client listens using DASH client library
              </li>
            </ul>
          </section>

          <section>
            <p>Is the complexity getting out of hand?</p>
          </section>
          <section>
            <p>What's the user flow like?</p>
          </section>
        </section>

        <section>
          <h1>Project reset</h1>
        </section>

        <section>
          <section>
            <h2>Two big ideas</h2>
          </section>
          <section>
            <table>
              <tr>
                <th>Static</th>
                <th>Server</th>
              </tr>
              <tr>
                <td>SPA</td>

                <td>Client server</td>
              </tr>
              <tr>
                <td>User "uploads" BRSTM</td>
                <td>User uploads BRSTM</td>
              </tr>
              <tr>
                <td>JS/WASM decode</td>
                <td>Server converts to MP3</td>
              </tr>
              <tr>
                <td>Web Audio API plays</td>
                <td>
                  HTML <code>&lt;audio /&gt;</code> to play or live streaming
                </td>
              </tr>
            </table>
          </section>
        </section>

        <section>
          <section>
            Let's try static solution
          </section>
          <section>
            <h2>Two main problems</h2>
            <ul>
              <li>How to decode BRSTM</li>
              <li>How to play audio using Web Audio API</li>
            </ul>
          </section>
        </section>

        <section>
          <h2>Extracting audio out of BRSTM file</h2>
        </section>

        <section>
          <section>
            <h2>Audio Crash Course, part 1</h2>
          </section>
          <section>
            <h2>Digital Audio</h2>
            <ul>
              <li>Analog sound wave &rarr; samples</li>
              <li>PCM: Pulse-code modulation</li>
              <li>Compression</li>
              <li>Codec: Coder-decoder</li>
              <li>Channels</li>
            </ul>
          </section>

          <section>
            <h2>Terminologies</h2>
            <ul>
              <li>Format</li>
              <li>Codec: Coder-decoder</li>
              <li>Channels</li>
            </ul>
          </section>
          <!-- https://docstore.mik.ua/orelly/web2/wdesign/ch24_01.htm -->
          <!-- https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API/Basic_concepts_behind_Web_Audio_API -->

          <!-- https://manual.audacityteam.org/man/digital_audio.html -->
        </section>

        <section>
          <section>
            <h2>Extracting BRSTM</h2>
            <p>For real</p>
          </section>

          <section>
            Only two "wiki" pages describing the file!

            <ul>
              <li>https://wiibrew.org/wiki/BRSTM_file</li>
              <li>http://wiki.tockdom.com/wiki/BRSTM_(File_Format)</li>
            </ul>
          </section>
          <section>
            <p>tl;dr:</p>

            <ul>
              <li>Format: BRSTM</li>
              <li>Codec: PCM or ADPCM</li>
              <li># Channels: specified in file</li>
              <li>Sections: HEAD, ADPC, DATA</li>
              <li>ADPC, DATA: Interleaved, in "blocks"</li>
            </ul>
          </section>

          <section>
            <p>
              So I started a simple page that accepts a BRSTM file and read its
              metadata
            </p>
          </section>

          <section>
            <p>Insert iframe or image?</p>
          </section>

          <section>
            <p>It works. What's next?</p>
          </section>
        </section>
        <section>
          <section>
            <h2>Decoding ADPCM</h2>
          </section>
          <section>
            <p>This is the codec</p>
            <i class="fragment">How to turn ADPCM into PCM?</i>
          </section>

          <section>
            <h2>There should be a NPM package for this</h2>
          </section>

          <section>
            <h2>
              <a href="https://www.npmjs.com/package/imaadpcm">imaadpcm</a>
              [insert npm screenshot]
            </h2>
          </section>

          <section>
            <h2>😱</h2>
          </section>

          <section>
            <p>and the input/output looks as expected!</p>
          </section>
        </section>

        <section>
          <section>
            <h2>Audio Player</h2>
            <aside class="notes">
              We need to build the "audio player", now that we have the audio
              data from BRSTM
            </aside>
          </section>

          <section>
            <h2>Web Audio API</h2>
            <aside class="notes">
              So we use Web Audio API. Heard rumours that it is so hard to use,
              I wonder if it's true.
            </aside>
          </section>
          <section>
            Insert illustration of Web Audio API:

            <!--
            <pre><code class="javascript" data-trim contenteditable style="font-size: 18px;" spellcheck="false">
const audioContext = new AudioContext(); // Web Audio API
const bufferSource = audioContext.createBufferSource(); // Web Audio API

const pcm = imaadpcm.decode(adpcm, metadata.blockSize); // external library
const normalizedPcm = normalize(pcm); // normalize [-32767..32768] (Int16) to [-1..1] (Float32)

// Create a Audio Buffer, part of Web Audio API
const audioBuffer = this.audioContext.createBuffer(1, normalizedPcm.length, metadata.sampleRate);
// Set pcm data to audio buffer
audioBuffer.getChannelData(0).set(normalizedPcm);

// Connecting stuffs, and play it
bufferSource.buffer = audioBuffer;
bufferSource.connect(audioContext.destination);
bufferSource.start(0);
                        </code></pre> -->
          </section>
          <section>
            So how's it?
          </section>
          <section>
            Insert image to my commit
          </section>
        </section>

        <section>
          <section>
            <h2>🕵️‍</h2>
            <aside class="notes">
              Something must have gone wrong. Did I decode BRSTM wrongly? If I'm
              wrong, what went wrong?
            </aside>
          </section>

          <section>
            <h2>ADPCM</h2>
            <span class="fragment">so many of them ...</span>
            <aside class="notes">
              Further research about ADPCM shows that there are so many
              different "ADPCM"

              <!-- https://wiki.multimedia.cx/index.php/Category:ADPCM_Audio_Codecs -->
            </aside>
          </section>

          <section>
            Insert screenshot of
            <!-- https://wiki.multimedia.cx/index.php/Category:ADPCM_Audio_Codecs -->
          </section>

          <section>
            <h2>Decoding <span class="fragment">Nintendo </span>ADPCM</h2>
            <aside class="notes">
              So when I say decoding ADPCM in context of BRSTM, it should be
              noted that the ADPCM codec is specific to Nintendo.
            </aside>
          </section>

          <section>
            <p>That means I can't use that npm package</p>
            <em class="fragment">sigh</em>
          </section>
        </section>
        <section>
          <section>
            <em>Scratching head</em>
          </section>
        </section>

        <section>
          <section>
            <h2>How did they do it?</h2>
            <a href="https://github.com/FFmpeg/FFmpeg">ffmpeg</a> (C)
          </section>
          <section>
            <a
              href="https://github.com/FFmpeg/FFmpeg/blob/master/libavformat/brstm.c"
              >brstm.c</a
            >
            <aside class="notes">
              I stare at that file for a very long time yet concluded that the
              adpcm decoder is not in that file.
            </aside>
          </section>
          <section>
            <a
              href="https://github.com/FFmpeg/FFmpeg/blob/master/libavcodec/adpcm.c"
              >adpcm.c</a
            >
            <aside class="notes">
              It's likely to be here, but it's so long cause it's handling so
              many ADPCM variants
            </aside>
          </section>
        </section>

        <section>
          <section>
            <h2>How did they do it?</h2>
            <a href="https://github.com/libertyernie/brawltools">BrawlBox</a>
            (C#)
          </section>

          <section>
            Insert BrawlBox screenshot (overview)
          </section>
          <section>
            Insert BrawlBox screenshot (playing)
          </section>

          <!-- 
            Randomly put debugger breakpoint
Load up BRSTM file
See which one actually does the decoding
Gotcha!
These three files are responsible

So how it does?
Per-block decoding
Basically magic

Ehm
My code vs their codes

Yep?
:(

Scratching head (2)
At this point, I was lost

EUREKA
Typos…
If you copy-paste codes that do magic, make sure you copy-paste them fully! (lesson)


          -->

          <section>
            <a
              href="https://github.com/libertyernie/brawltools/blob/master/BrawlLib/Wii/Audio/ADPCMStream.cs"
              >ADPCMStream.cs</a
            ><br />
            <a
              href="https://github.com/libertyernie/brawltools/blob/master/BrawlLib/Wii/Audio/ADPCMState.cs"
              >ADPCMState.cs</a
            >
            <aside class="notes">
              Should be somewhere here, but it's still very cryptic
            </aside>
          </section>
          <section>
            <em>So what I do?</em>
          </section>

          <section>
            <p>Attach debugger!</p>
            <aside class="notes">
              Because Visual Studio has reputation with its debugger
            </aside>
          </section>

          <section>
            Insert screenshots of debugging

            <aside class="notes">
              and so I thought, between this point and this point, these codes
              are running, so I should replicate those codes in JS.
            </aside>
          </section>

          <section>
            Insert screenshot
          </section>
        </section>

        <section>
          <section>
            <h2>Eureka!</h2>

            <!-- https://github.com/kenrick95/nikku/blob/f98814df754b6e70109074c2a944516a26ea6c2e/src/brstm.js -->
          </section>

          <section>
            Insert iframe to that "state" demo
          </section>
        </section>

        <section>
          <section>
            Is it finished?
          </section>

          <section>
            No
          </section>

          <section>
            Audio Player is far from finished
          </section>
        </section>

        <section>
          <section>
            <h2>Nuances</h2>

            <p>Web Audio API is hard</p>
          </section>
          <section>
            <h3>Audio Player</h3>
            <ul>
              <li>Play/pause</li>
              <li>Display current playback time</li>
              <li>Seek</li>
              <li>Loop</li>
            </ul>
          </section>
          <section>
            <h3>Looping</h3>
            <!--
              Easy
Buffer.loop = true
Buffer.loopStart = … // in SECONDS!?
Buffer.loopEnd = … // in SECONDS!?
Comment
Bizarre. Usually devs will like to avoid floating point numbers, but Web Audio API seems to love using floating points.


            -->
          </section>
          <section>
            <h3>Play/pause</h3>
            <!--
              Easy now
These methods have been added to the standard and are widely available
audioContext.resume
audioContext.suspend

            -->
          </section>

          <section>
            <h3>Seek</h3>
            <!--
              Difficulty: Medium
In ideal world (<audio>), it is easy
Audio.time=… // in seconds
In Web Audio API, it’s kinda hard
Need to stop the audio buffer, reinitialize buffer, then start playback at the sought time


            -->
          </section>
          <section>
            <h3>Playback time display</h3>
            <!-- 
              How to display current playback time?
If no loop, it’s easy
audioContext.currentTime
If I have loop, it’s impossible
That current time will keep increase even after loop
Proposal to add “playback time” to the standard
My workaround: Don’t rely on their timer, it’s less accurate, but more control in my side.
Set/unset the current timestamp for play/pause/seek/etc

            -->
          </section>
        </section>

        <section>
          <section>
            Final product demo
          </section>
        </section>

        <section>
          <section>
            Marketing
          </section>
          <section>
            Posted to
            <a
              href="https://www.reddit.com/r/BRSTM/comments/bky6p0/i_created_a_webbased_brstm_player/"
              >r/BRSTM</a
            >
            and
            <a href="https://forums.kc-mm.com/index.php?topic=80370.0"
              >a Nintendo modding forum</a
            >.
          </section>
          <section>
            Reception?
          </section>
          <section>
            Received bug reports, I didn't handle few edge cases. They are kind
            enough to provide the files to reproduce the bug. 1. BRSTM can
            contain raw PCMs too (I only handled if they contained ADPCM). 2.
            BRSTM can have more than one "stream" (pair of channels). So amazed.
            BrawlBox actually handled this.
          </section>
        </section>

        <section>
          <section>
            Lessons
          </section>

          <section>
            Define the project scope before starting anything
          </section>
          <section>
            Do research, lots of research, especially if you are unfamiliar with
            the topic.
          </section>
          <section>
            Don't be afraid to read others' codes. Codes never lie. 
          </section>
          <section>
            Web Audio API is difficult to use 😢
          </section>
        </section>

        <section>
          <blockquote>Do things, tell people</blockquote>
          <aside class="notes">
            It's really amazing quote. Heard it long time ago, when I just
            started university. It made me want to work on side projects. and
            after finishing it, telling people about it. Either by posting it to
            HN or writing it up in my blog.
          </aside>
        </section>

        <section>
          <h2>Kenrick</h2>
          <a href="https://blog.kenrick95.org/">blog.kenrick95.org</a>
        </section>
      </div>
    </div>

    <script src="js/reveal.js"></script>

    <script>
      // More info https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: true,
        progress: true,
        center: true,
        hash: true,

        transition: 'slide', // none/fade/slide/convex/concave/zoom

        // More info https://github.com/hakimel/reveal.js#dependencies
        dependencies: [
          {
            src: 'plugin/markdown/marked.js',
            condition: function() {
              return !!document.querySelector('[data-markdown]');
            }
          },
          {
            src: 'plugin/markdown/markdown.js',
            condition: function() {
              return !!document.querySelector('[data-markdown]');
            }
          },
          { src: 'plugin/highlight/highlight.js', async: true },
          { src: 'plugin/search/search.js', async: true },
          { src: 'plugin/zoom-js/zoom.js', async: true },
          { src: 'plugin/notes/notes.js', async: true }
        ]
      });
    </script>
    <script
      src="//localhost:35729/livereload.js"
      async="true"
      defer="true"
    ></script>
  </body>
</html>
